name: Build SD WebUI Forge

on:
  push:
  # delete:
  create:

jobs:
  Build-SD-WebUI-Forge:
    name: Build SD WebUI Forge
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enter Workspace
        shell: pwsh
        run: |
          Set-Location -Path "${{ github.workspace }}"

      - name: List files in the repository
        shell: pwsh
        run: |
          Get-ChildItem -Path "${{ github.workspace }}" -Recurse

      - name: Launch SD WebUI Installer
        shell: pwsh
        run: |
          & "${{ github.workspace }}/stable_diffusion_webui_installer.ps1" `
            -InstallPath "${{ github.workspace }}/sd_webui_reforge" `
            -BuildMode `
            -BuildWithUpdate `
            -BuildWithUpdateExtension `
            -BuildWithLaunch `
            -BuildWithTorch 21 `
            -BuildWitchBranch 4 `
            -InstallBranch "sd_webui_reforge" `
            -NoPreDownloadModel `
            -DisablePipMirror `
            -DisableGithubMirror `
            -DisableHuggingFaceMirror

      - name: Install Insightface
        shell: pwsh
        env:
          PIP_NO_WARN_SCRIPT_LOCATION: 0
          PIP_DISABLE_PIP_VERSION_CHECK: 1
        run: |
          & "${{ github.workspace }}/sd_webui_reforge/python/python.exe" -m pip install insightface

      - name: Install Hanamizuki
        shell: pwsh
        run: |
          $url = "https://modelscope.cn/models/licyks/invokeai-core-model/resolve/master/pypatchmatch/hanamizuki.exe"
          Invoke-WebRequest -Uri $url -OutFile "${{ github.workspace }}/sd_webui_reforge/stable-diffusion-webui"
          Move-Item -Path "${{ github.workspace }}/sd_webui_reforge/python" "${{ github.workspace }}/sd_webui_forge/stable-diffusion-webui/python" -Force
          Move-Item -Path "${{ github.workspace }}/sd_webui_reforge/git" "${{ github.workspace }}/sd_webui_forge/stable-diffusion-webui/git" -Force
          $content = "
              @echo off
              if exist `"%~dp0`"\stable-diffusion-webui (
                  cd /d `"%~dp0`"\stable-diffusion-webui
              ) else (
                  echo Stable Diffusion WebUI not found
                  pause
                  exit 1
              )
              if exist .\hanamizuki.exe (
                  echo Launch Hanamizuki
                  .\hanamizuki.exe
              ) else (
                  echo Hanamizuki not found
                  pause
                  exit 1
              )
          "
          Set-Content -Encoding Default -Path "${{ github.workspace }}/sd_webui_reforge/hanamizuki.bat" -Value $content

      - name: Make docs
        shell: pwsh
        run: |
          $content = @(
            "https://space.bilibili.com/46497516"
          )
          Set-Content -Encoding UTF8 -Path "${{ github.workspace }}/sd_webui_reforge/bilibili@licyk_.txt" -Value $content

          $content = @(
            "首次使用需要双击运行 configure_env.bat 配置环境",
            "运行后即可正常运行 PowerShell 脚本, PowerShell 脚本需要右键后选择 `"使用 PowerShell 运行`" 才可以运行",
            "简单使用说明可打开 help.txt 进行阅读",
            "更多说明请阅读: https://github.com/licyk/sd-webui-all-in-one/discussions/1"
          )
          Set-Content -Encoding UTF8 -Path "${{ github.workspace }}/sd_webui_reforge/说明.txt" -Value $content

      - name: Make configure env script
        shell: pwsh
        run: |
          Copy-Item -Path "${{ github.workspace }}/configure_env.bat" -Destination "${{ github.workspace }}/sd_webui_reforge/configure_env.bat" -Force

      - name: Archive
        shell: pwsh
        run: |
          $build_time = (Get-Date).ToString("yyyyMMdd")
          $package_name = "sd_webui_reforge_licyk_${build_time}"
          $protable_name = "${package_name}_nightly.7z"
          New-Item -ItemType Directory -Path "${{ github.workspace }}/sdnote/portable/nightly" -Force
          Move-Item -Path "${{ github.workspace }}/sd_webui" "${{ github.workspace }}/${package_name}" -Force
          7z a -t7z "${{ github.workspace }}/sdnote/portable/nightly/${protable_name}" "${{ github.workspace }}/${package_name}"

      - name: Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sd_webui_nightly
          path: ${{ github.workspace }}/sdnote/portable/nightly/

      - name: Install HuggingFace library
        shell: pwsh
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: 1
        run: |
          pip install huggingface_hub

      - name: Upload to HuggingFacee repo
        shell: python
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          WORKSPACE: ${{ github.workspace }}
        run: |
          import os
          from huggingface_hub import upload_large_folder

          upload_large_folder(
            repo_id="licyk/sdnote",
            repo_type="model",
            folder_path=os.path.join(os.environ.get("WORKSPACE"), "sdnote")
          )

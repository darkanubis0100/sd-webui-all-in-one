name: Build Musubi Tuner

on:
  push:
  # delete:
  # create:
  schedule:
  # * is a special character in YAML so you have to quote this string
  # UTC 17:00 -> CST (China) 1:00, see https://datetime360.com/cn/utc-cst-china-time/
  # https://docs.github.com/zh/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#schedule
  - cron: '0 17 * * 0'

jobs:
  Build-Musubi-Tuner:
    name: Build Musubi Tuner
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enter Workspace
        shell: pwsh
        run: |
          Set-Location -Path "${{ github.workspace }}"

      - name: List files in the repository
        shell: pwsh
        run: |
          Get-ChildItem -Path "${{ github.workspace }}" -Recurse

      - name: Launch SD-Trainer-Script Installer
        shell: pwsh
        run: |
          & "${{ github.workspace }}/sd_trainer_script_installer.ps1" `
            -InstallPath "${{ github.workspace }}/musubi_tuner" `
            -BuildMode `
            -BuildWithUpdate `
            -BuildWithLaunch `
            -BuildWithTorch 24 `
            -BuildWitchBranch 7 `
            -InstallBranch "musubi_tuner" `
            -DisablePipMirror `
            -DisableGithubMirror `
            -DisableHuggingFaceMirror

      - name: Make docs
        shell: pwsh
        run: |
          python "${{ github.workspace }}/.github/make_docs.py" "${{ github.workspace }}/musubi_tuner"

      - name: Make configure env script
        shell: pwsh
        run: |
          Copy-Item -Path "${{ github.workspace }}/configure_env.bat" -Destination "${{ github.workspace }}/musubi_tuner/configure_env.bat" -Force

      - name: Archive
        shell: pwsh
        run: |
          $build_time = (Get-Date).ToString("yyyyMMdd")
          $package_name = "musubi_tuner_licyk_${build_time}"
          $protable_name = "${package_name}_nightly.7z"
          New-Item -ItemType Directory -Path "${{ github.workspace }}/sdnote/portable/nightly" -Force
          Move-Item -Path "${{ github.workspace }}/musubi_tuner" -Destination "${{ github.workspace }}/${package_name}" -Force
          7z a -t7z "${{ github.workspace }}/sdnote/portable/nightly/musubi_tuner/${protable_name}" "${{ github.workspace }}/${package_name}"

      - name: Artifact
        uses: actions/upload-artifact@v4
        with:
          name: musubi_tuner_nightly
          path: ${{ github.workspace }}/sdnote/portable/nightly/

      - name: Install HuggingFace / ModelScope library
        shell: pwsh
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: 1
        run: |
          pip install huggingface_hub modelscope

      - name: Upload to HuggingFacee repo
        shell: python
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          WORKSPACE: ${{ github.workspace }}
        run: |
          import os
          from huggingface_hub import upload_large_folder

          upload_large_folder(
            repo_id="licyk/sdnote",
            repo_type="model",
            folder_path=os.path.join(os.environ.get("WORKSPACE"), "sdnote")
          )

      - name: Upload to ModelScope repo
        shell: python
        env:
          MODELSCOPE_API_TOKEN: ${{ secrets.MODELSCOPE_API_TOKEN }}
          WORKSPACE: ${{ github.workspace }}
        run: |
          import os
          from modelscope.hub.api import HubApi

          api = HubApi()
          api.login(os.environ.get("MODELSCOPE_API_TOKEN"))

          api.upload_folder(
              repo_id="licyks/sdnote",
              repo_type="model",
              folder_path=os.path.join(os.environ.get("WORKSPACE"), "sdnote")
          )
